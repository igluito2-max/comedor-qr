<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Residencia Comedor QR</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        #qr-result { font-size: 1.2em; margin: 10px 0; }
        #qr-debug { font-size: 1em; color: blue; margin: 5px 0; }
        .verde { color: green; }
        .rojo { color: red; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 5px; text-align: left; }
    </style>
</head>
<body>
    <h1>Residencia Comedor QR</h1>
    
    <label for="select-turno">Selecciona turno:</label>
    <select id="select-turno">
        <option value="Viernes_Comida">Viernes - Comida</option>
        <option value="Viernes_Cena">Viernes - Cena</option>
        <option value="Sabado_Comida">Sábado - Comida</option>
        <option value="Sabado_Cena">Sábado - Cena</option>
        <option value="Domingo_Comida">Domingo - Comida</option>
        <option value="Domingo_Cena">Domingo - Cena</option>
    </select>

    <div id="qr-reader" style="width: 300px; margin-top:20px;"></div>
    <div id="qr-result">Esperando QR...</div>
    <div id="qr-debug">Cargando DB...</div>

    <h2>Historial</h2>
    <table id="historial">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Turno</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const GET_URL = "https://script.google.com/macros/s/AKfycbyHgXccC8ygFN5w28-wMEsvLnvFBL2Is_CSQv6-DXiddNA1UZaoLLyv64ry_XXXKmf7/exec";        const POST_URL = GET_URL;
        let DB = {};
        let asistencia = [];

        // Cargar DB desde Web App
        async function loadDB(){
            try{
                const res = await fetch(GET_URL);
                const data = await res.json();
                DB = {};
                data.forEach(row => {
                    // Ajusta la propiedad según tu JSON (ID o id)
                    DB[row.id.trim().toUpperCase()] = row;
                });
                document.getElementById("qr-debug").innerText = "DB cargada ✅";
            }catch(err){
                console.error("Error cargando DB:", err);
                document.getElementById("qr-debug").innerText = "Error cargando DB ❌";
            }
        }

        // Función que se llama cuando se escanea un QR
        async function checkID(id){
            const debugDiv = document.getElementById("qr-debug");
            debugDiv.innerText = "QR leído: [" + id + "]";

            id = id.trim().toUpperCase();
            const turno = document.getElementById("select-turno").value;
            const resultadoDiv = document.getElementById("qr-result");
            const tbody = document.querySelector("#historial tbody");

            if(DB[id]){
                let comida = Number(DB[id][turno].toString().trim());
                let estado = comida === 1 ? "Asistió" : "No asistió";

                resultadoDiv.innerHTML = DB[id].Nombre + (estado=="Asistió" ? " puede comer ✅" : " NO tiene esta comida ❌");
                resultadoDiv.className = estado=="Asistió" ? "verde" : "rojo";

                // Enviar registro a Google Sheets
                try{
                    await fetch(POST_URL,{
                        method:"POST",
                        headers:{"Content-Type":"application/json"},
                        body: JSON.stringify({id:id,nombre:DB[id].Nombre,turno:turno,estado:estado})
                    });
                }catch(e){
                    console.error("Error enviando asistencia:", e);
                }

                // Añadir al historial local
                asistencia.push({id:id,nombre:DB[id].Nombre,turno:turno,estado:estado});
                const row = document.createElement("tr");
                row.innerHTML = `<td>${id}</td><td>${DB[id].Nombre}</td><td>${turno}</td><td>${estado}</td>`;
                tbody.appendChild(row);

            } else {
                resultadoDiv.innerHTML = "ID no válido ❌";
                resultadoDiv.className = "rojo";
            }
        }

        // Inicializar escáner después de cargar DB
        async function initScanner(){
            await loadDB();
            let html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(checkID);
        }

        initScanner();

        // Recargar DB cada 10 segundos
        setInterval(loadDB, 10000);
    </script>
</body>
</html>
